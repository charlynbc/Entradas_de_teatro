const express = require('express');
const cors = require('cors');
const crypto = require('crypto');
const QRCode = require('qrcode');

const app = express();
const PORT = process.env.PORT || 3000;
const BASE_URL = process.env.BASE_URL || 'http://localhost:3000';

app.use(cors());
app.use(express.json());

// ====== "Base de datos" en memoria (despu茅s la pasamos a Postgres) ======
let shows = [];           // funciones
let tickets = new Map();  // key: code, value: ticket object
let usuarios = [];        // usuarios (ADMIN y VENDEDOR)
let showIdCounter = 1;
let usuarioIdCounter = 1;

// Crear admins por defecto
usuarios.push(
  { id: 1, nombre: 'Admin 1', email: 'admin1@baco.com', rol: 'ADMIN', activo: true },
  { id: 2, nombre: 'Admin 2', email: 'admin2@baco.com', rol: 'ADMIN', activo: true },
  { id: 3, nombre: 'Admin 3', email: 'admin3@baco.com', rol: 'ADMIN', activo: true }
);
usuarioIdCounter = 4;

// Utilidad para generar c贸digo de ticket
function generateTicketCode() {
  return 'T-' + crypto.randomBytes(4).toString('hex').toUpperCase(); // ej: T-A1B2C3D4
}

// Utilidad para generar QR code
async function generarQR(code) {
  try {
    const url = `${BASE_URL}/validar?code=${code}`;
    const dataUrl = await QRCode.toDataURL(url);
    return dataUrl;
  } catch (error) {
    console.error('Error generando QR:', error);
    return null;
  }
}

// ====== Rutas ======

// Healthcheck para Render
app.get('/', (req, res) => {
  res.send('API Teatro Tickets OK - Sistema Baco v2');
});

// Crear una funci贸n (obra + fecha + capacidad)
app.post('/api/shows', (req, res) => {
  const { obra, fecha, capacidad } = req.body;

  if (!obra || !fecha || !capacidad) {
    return res.status(400).json({ error: 'obra, fecha y capacidad son obligatorios' });
  }

  const show = {
    id: showIdCounter++,
    obra,
    fecha,       // string tipo "2025-12-24 21:00"
    capacidad,   // ej: 100
    createdAt: new Date().toISOString()
  };

  shows.push(show);
  res.status(201).json(show);
});

// Listar funciones
app.get('/api/shows', (req, res) => {
  res.json(shows);
});

// Generar N tickets para una funci贸n
app.post('/api/shows/:id/generate-tickets', async (req, res) => {
  const showId = parseInt(req.params.id, 10);
  const { cantidad } = req.body;

  const show = shows.find(s => s.id === showId);
  if (!show) {
    return res.status(404).json({ error: 'Funci贸n no encontrada' });
  }

  if (!cantidad || cantidad <= 0) {
    return res.status(400).json({ error: 'cantidad debe ser mayor a 0' });
  }

  const generated = [];

  for (let i = 0; i < cantidad; i++) {
    let code;
    do {
      code = generateTicketCode();
    } while (tickets.has(code)); // aseguramos unicidad

    // Generar QR code
    const qrCode = await generarQR(code);

    const ticket = {
      code,
      showId,
      estado: 'DISPONIBLE',         // DISPONIBLE | STOCK_VENDEDOR | RESERVADO | PAGADO | USADO
      qrCode,                       // imagen QR en base64
      
      // Propiedad y venta
      propietarioId: null,          // vendedor que tiene el ticket en su stock
      vendedorId: null,             // vendedor que hizo la reserva/venta
      compradorNombre: null,
      compradorContacto: null,
      medioPago: null,              // EFECTIVO | TRANSFERENCIA | PREX | OTRO
      monto: null,
      
      // Timestamps
      createdAt: new Date().toISOString(),
      reservadoAt: null,
      pagadoAt: null,
      usadoAt: null
    };

    tickets.set(code, ticket);
    generated.push(ticket);
  }

  res.status(201).json({
    showId,
    cantidad: generated.length,
    tickets: generated
  });
});

// Listar tickets de una funci贸n
app.get('/api/shows/:id/tickets', (req, res) => {
  const showId = parseInt(req.params.id, 10);

  const show = shows.find(s => s.id === showId);
  if (!show) {
    return res.status(404).json({ error: 'Funci贸n no encontrada' });
  }

  const result = [];
  for (const ticket of tickets.values()) {
    if (ticket.showId === showId) {
      result.push(ticket);
    }
  }

  res.json(result);
});

// Marcar ticket como PAGADO
app.post('/api/tickets/:code/pay', (req, res) => {
  const { code } = req.params;
  const ticket = tickets.get(code);

  if (!ticket) {
    return res.status(404).json({ error: 'Ticket no encontrado' });
  }

  if (ticket.estado === 'USADO') {
    return res.status(400).json({ error: 'El ticket ya fue usado' });
  }

  ticket.estado = 'PAGADO';
  ticket.pagadoAt = new Date().toISOString();

  tickets.set(code, ticket);
  res.json(ticket);
});

// Validar ticket (en la puerta del teatro)
app.post('/api/tickets/:code/validate', (req, res) => {
  const { code } = req.params;
  const ticket = tickets.get(code);

  if (!ticket) {
    return res.status(400).json({ valido: false, motivo: 'Ticket inexistente' });
  }

  if (ticket.estado === 'USADO') {
    return res.status(400).json({ valido: false, motivo: 'Ticket ya usado' });
  }

  if (ticket.estado !== 'PAGADO') {
    return res.status(400).json({ valido: false, motivo: 'Ticket no est谩 pagado' });
  }

  ticket.estado = 'USADO';
  ticket.usadoAt = new Date().toISOString();
  tickets.set(code, ticket);

  res.json({
    valido: true,
    mensaje: 'Ticket v谩lido, bienvenido ',
    ticket
  });
});

// Obtener info de un ticket (debug / administraci贸n)
app.get('/api/tickets/:code', (req, res) => {
  const { code } = req.params;
  const ticket = tickets.get(code);

  if (!ticket) {
    return res.status(404).json({ error: 'Ticket no encontrado' });
  }

  res.json(ticket);
});

// ====== NUEVOS ENDPOINTS - GESTIN DE VENTAS ======

// Registrar venta de un ticket
app.post('/api/tickets/:code/sell', (req, res) => {
  const { code } = req.params;
  const { vendedorId, compradorNombre, compradorContacto, medioPago, monto } = req.body;

  const ticket = tickets.get(code);

  if (!ticket) {
    return res.status(404).json({ error: 'Ticket no encontrado' });
  }

  if (ticket.estado === 'USADO') {
    return res.status(400).json({ error: 'El ticket ya fue usado' });
  }

  if (ticket.estado === 'PAGADO') {
    return res.status(400).json({ error: 'El ticket ya fue vendido' });
  }

  // Validar que el vendedor exista
  if (vendedorId) {
    const vendedor = vendedores.find(v => v.id === vendedorId);
    if (!vendedor) {
      return res.status(404).json({ error: 'Vendedor no encontrado' });
    }
    if (!vendedor.activo) {
      return res.status(400).json({ error: 'Vendedor inactivo' });
    }
  }

  // Actualizar ticket con datos de venta
  ticket.estado = 'PAGADO';
  ticket.vendedorId = vendedorId || null;
  ticket.compradorNombre = compradorNombre || null;
  ticket.compradorContacto = compradorContacto || null;
  ticket.medioPago = medioPago || 'EFECTIVO';
  ticket.monto = monto || 0;
  ticket.pagadoAt = new Date().toISOString();

  tickets.set(code, ticket);
  
  res.json({
    mensaje: 'Ticket vendido exitosamente',
    ticket
  });
});

// ====== ENDPOINTS DE VENDEDORES ======

// Listar vendedores
app.get('/api/vendedores', (req, res) => {
  res.json(vendedores);
});

// Crear vendedor
app.post('/api/vendedores', (req, res) => {
  const { nombre, alias } = req.body;

  if (!nombre) {
    return res.status(400).json({ error: 'nombre es obligatorio' });
  }

  const vendedor = {
    id: vendedorIdCounter++,
    nombre,
    alias: alias || nombre,
    activo: true,
    createdAt: new Date().toISOString()
  };

  vendedores.push(vendedor);
  res.status(201).json(vendedor);
});

// Actualizar vendedor
app.put('/api/vendedores/:id', (req, res) => {
  const id = parseInt(req.params.id, 10);
  const { nombre, alias, activo } = req.body;

  const vendedor = vendedores.find(v => v.id === id);
  if (!vendedor) {
    return res.status(404).json({ error: 'Vendedor no encontrado' });
  }

  if (nombre !== undefined) vendedor.nombre = nombre;
  if (alias !== undefined) vendedor.alias = alias;
  if (activo !== undefined) vendedor.activo = activo;

  res.json(vendedor);
});

// Desactivar vendedor
app.delete('/api/vendedores/:id', (req, res) => {
  const id = parseInt(req.params.id, 10);

  const vendedor = vendedores.find(v => v.id === id);
  if (!vendedor) {
    return res.status(404).json({ error: 'Vendedor no encontrado' });
  }

  vendedor.activo = false;
  res.json({ mensaje: 'Vendedor desactivado', vendedor });
});

// ====== REPORTES ======

// Reporte de ventas por vendedor
app.get('/api/reportes/ventas', (req, res) => {
  const { showId } = req.query;

  let ticketsToAnalyze = Array.from(tickets.values());

  // Filtrar por funci贸n si se especifica
  if (showId) {
    const sid = parseInt(showId, 10);
    ticketsToAnalyze = ticketsToAnalyze.filter(t => t.showId === sid);
  }

  // Agrupar por vendedor
  const ventasPorVendedor = {};

  ticketsToAnalyze.forEach(ticket => {
    if (ticket.estado === 'PAGADO' || ticket.estado === 'USADO') {
      const vendedorId = ticket.vendedorId || 'sin_vendedor';
      
      if (!ventasPorVendedor[vendedorId]) {
        const vendedor = vendedores.find(v => v.id === ticket.vendedorId);
        ventasPorVendedor[vendedorId] = {
          vendedorId: ticket.vendedorId,
          vendedorNombre: vendedor ? vendedor.nombre : 'Sin vendedor',
          vendedorAlias: vendedor ? vendedor.alias : 'N/A',
          cantidadVendida: 0,
          montoTotal: 0,
          tickets: []
        };
      }

      ventasPorVendedor[vendedorId].cantidadVendida++;
      ventasPorVendedor[vendedorId].montoTotal += ticket.monto || 0;
      ventasPorVendedor[vendedorId].tickets.push({
        code: ticket.code,
        compradorNombre: ticket.compradorNombre,
        medioPago: ticket.medioPago,
        monto: ticket.monto,
        pagadoAt: ticket.pagadoAt
      });
    }
  });

  const resultado = Object.values(ventasPorVendedor);

  res.json({
    showId: showId ? parseInt(showId, 10) : null,
    totalVentas: ticketsToAnalyze.filter(t => t.estado === 'PAGADO' || t.estado === 'USADO').length,
    montoTotal: ticketsToAnalyze.reduce((sum, t) => sum + (t.monto || 0), 0),
    vendedores: resultado
  });
});

// Estad铆sticas generales de una funci贸n
app.get('/api/shows/:id/stats', (req, res) => {
  const showId = parseInt(req.params.id, 10);

  const show = shows.find(s => s.id === showId);
  if (!show) {
    return res.status(404).json({ error: 'Funci贸n no encontrada' });
  }

  const ticketsDeShow = Array.from(tickets.values()).filter(t => t.showId === showId);

  const stats = {
    showId,
    obra: show.obra,
    fecha: show.fecha,
    capacidad: show.capacidad,
    totalGenerados: ticketsDeShow.length,
    disponibles: ticketsDeShow.filter(t => t.estado === 'DISPONIBLE').length,
    pagados: ticketsDeShow.filter(t => t.estado === 'PAGADO').length,
    usados: ticketsDeShow.filter(t => t.estado === 'USADO').length,
    montoRecaudado: ticketsDeShow.reduce((sum, t) => sum + (t.monto || 0), 0),
    porcentajeVendido: show.capacidad > 0 
      ? ((ticketsDeShow.filter(t => t.estado === 'PAGADO' || t.estado === 'USADO').length / show.capacidad) * 100).toFixed(2) 
      : 0
  };

  res.json(stats);
});

// Arrancar servidor
app.listen(PORT, () => {
  console.log(`Servidor escuchando en puerto ${PORT}`);
});
