<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Perfil - BAC√ì</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;700;900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/baco-common.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --negro: #0a0a0a;
            --bordo: #8B1538;
            --dorado: #D4AF37;
            --blanco: #F8F8F8;
            --gris-oscuro: #1a1a1a;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--negro);
            color: var(--blanco);
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, var(--gris-oscuro), var(--negro));
            padding: 20px;
            border-bottom: 1px solid rgba(212, 175, 55, 0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .btn-back {
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid var(--dorado);
            color: var(--dorado);
            padding: 10px 15px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-back:hover {
            background: var(--dorado);
            color: var(--negro);
        }

        .header-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            color: var(--dorado);
        }

        .btn-logout-header {
            background: rgba(139, 21, 56, 0.2);
            border: 1px solid var(--bordo);
            color: var(--bordo);
            padding: 10px 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .btn-logout-header:hover {
            background: var(--bordo);
            color: var(--blanco);
        }

        .container {
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .profile-card {
            background: linear-gradient(135deg, var(--gris-oscuro), #252525);
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 25px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
        }

        .profile-photo-large {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            border: 4px solid var(--dorado);
            margin: 0 auto 25px;
            overflow: hidden;
            box-shadow: 0 0 40px rgba(212, 175, 55, 0.4);
            background: var(--gris-oscuro);
            position: relative;
        }

        .profile-photo-large img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .change-photo-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0;
        }

        .profile-photo-large:hover .change-photo-overlay {
            opacity: 1;
        }

        .profile-name-large {
            font-family: 'Playfair Display', serif;
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--blanco), var(--dorado));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .profile-role-large {
            color: var(--dorado);
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .profile-cedula {
            color: rgba(248, 248, 248, 0.6);
            font-size: 0.95rem;
        }

        .btn-change-photo {
            background: linear-gradient(135deg, var(--dorado), #F4E3B5);
            color: var(--negro);
            border: none;
            padding: 12px 30px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn-change-photo:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.5);
        }

        .section {
            background: linear-gradient(135deg, var(--gris-oscuro), #1f1f1f);
            border: 1.5px solid rgba(212, 175, 55, 0.2);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 25px;
        }

        .section-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            color: var(--dorado);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: rgba(248, 248, 248, 0.8);
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 0.95rem;
        }

        .form-group input {
            width: 100%;
            padding: 14px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1.5px solid rgba(212, 175, 55, 0.3);
            border-radius: 12px;
            color: var(--blanco);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--dorado);
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.2);
        }

        .btn-save {
            background: linear-gradient(135deg, var(--bordo), #A31D45);
            color: white;
            border: none;
            padding: 14px 35px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-size: 1rem;
        }

        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 21, 56, 0.5);
        }

        .alert {
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: none;
            animation: slideIn 0.4s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .alert-success {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            border: 1px solid #86efac;
        }

        .alert-error {
            background: linear-gradient(135deg, var(--bordo), #A31D45);
            color: white;
            border: 1px solid #fca5a5;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .profile-card {
                padding: 30px 20px;
            }

            .profile-photo-large {
                width: 150px;
                height: 150px;
            }

            .profile-name-large {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <a href="admin-dashboard.html" class="btn-back">
                <i class="fas fa-arrow-left"></i>
                Volver
            </a>
            <h1 class="header-title">Mi Perfil</h1>
        </div>
        <button class="btn-logout-header" onclick="handleLogout()">
            <i class="fas fa-sign-out-alt"></i>
            Cerrar Sesi√≥n
        </button>
    </header>

    <div class="container">
        <!-- CARD PERFIL -->
        <div class="profile-card">
            <div class="profile-photo-large photo-circular" style="width: 180px; height: 180px; margin: 0 auto 25px;">
                <img src="https://via.placeholder.com/180/1a1a1a/D4AF37?text=BC" alt="Foto de perfil" id="profilePhotoLarge" onerror="this.src=Baco.Image.getPlaceholder('Super', 180)">
                <div class="change-photo-overlay" onclick="document.getElementById('photoInput').click()">
                    <i class="fas fa-camera"></i> Cambiar
                </div>
            </div>
            <input type="file" id="photoInput" accept="image/*" style="display: none;" onchange="handlePhotoChange(event)">
            
            <h2 class="profile-name-large" id="profileNameLarge">Super Usuario</h2>
            <div class="profile-role-large">Super Usuario</div>
            <div class="profile-cedula">CI: <span id="profileCedula">-</span></div>
            <div class="frase-teatral" id="fraseDelDia" style="margin-top: 20px; font-style: italic; color: rgba(212, 175, 55, 0.9); font-size: 0.95rem; max-width: 500px; margin-left: auto; margin-right: auto;">
                <i class="fas fa-quote-left" style="font-size: 0.8rem; opacity: 0.6; margin-right: 5px;"></i>
                <span id="fraseTexto">Cargando frase...</span>
                <i class="fas fa-quote-right" style="font-size: 0.8rem; opacity: 0.6; margin-left: 5px;"></i>
            </div>
        </div>

        <!-- DATOS PERSONALES -->
        <div class="section">
            <h3 class="section-title">
                <i class="fas fa-user-edit"></i>
                Datos Personales
            </h3>
            
            <form id="formPersonal" onsubmit="updatePersonalInfo(event)">
                <div class="form-group">
                    <label>Nombre Completo *</label>
                    <input type="text" id="nombre" required placeholder="Juan P√©rez">
                </div>

                <div class="form-group">
                    <label>C√©dula</label>
                    <input type="text" id="cedula" readonly style="background: rgba(255,255,255,0.03); cursor: not-allowed;">
                </div>

                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="email" placeholder="super@baco.com">
                </div>

                <div class="form-group">
                    <label>Fecha de Nacimiento</label>
                    <input type="date" id="fecha_nacimiento">
                </div>

                <div class="form-group">
                    <label>Tel√©fono</label>
                    <input type="tel" id="telefono" placeholder="099 123 456">
                </div>

                <button type="submit" class="btn-save">
                    <i class="fas fa-check"></i>
                    Guardar Cambios
                </button>
            </form>
        </div>

        <!-- CAMBIAR CONTRASE√ëA -->
        <div class="section">
            <h3 class="section-title">
                <i class="fas fa-lock"></i>
                Cambiar Contrase√±a
            </h3>
            
            <div id="alertPassword" class="alert"></div>

            <form id="formPassword" onsubmit="changePassword(event)">
                <div class="form-group">
                    <label>Contrase√±a Actual</label>
                    <input type="password" id="currentPassword" required>
                </div>

                <div class="form-group">
                    <label>Nueva Contrase√±a</label>
                    <input type="password" id="newPassword" required minlength="6">
                </div>

                <div class="form-group">
                    <label>Confirmar Nueva Contrase√±a</label>
                    <input type="password" id="confirmPassword" required minlength="6">
                </div>

                <button type="submit" class="btn-save">
                    <i class="fas fa-check"></i>
                    Guardar Contrase√±a
                </button>
            </form>
        </div>
    </div>

    <script src="/js/baco-common.js"></script>
    <script>
        (function () {
        // Frases teatrales aleatorias (100 frases - mismas que en index.html)
        const quotes = [
            { text: "El teatro es poes√≠a que se hace humana", author: "Federico Garc√≠a Lorca" },
            { text: "Todo el mundo es un escenario", author: "William Shakespeare, As You Like It" },
            { text: "El teatro no puede desaparecer porque es el √∫nico arte donde la humanidad se enfrenta a s√≠ misma", author: "Arthur Miller" },
            { text: "Actuar es vivir sinceramente bajo circunstancias imaginarias", author: "Sanford Meisner" },
            { text: "El teatro es un espejo en el que nos miramos todos", author: "Julio C√©sar (Shakespeare)" },
            { text: "El actor es un atleta del coraz√≥n", author: "Antonin Artaud" },
            { text: "Dame un punto fijo y mover√© el mundo", author: "Arqu√≠medes" },
            { text: "La vida es una obra sin ensayos", author: "Charles Chaplin" },
            { text: "En el teatro, el silencio tiene voz", author: "Peter Brook" },
            { text: "El teatro es la primera ficci√≥n de la humanidad", author: "Edward Gordon Craig" },
            { text: "El p√∫blico es el actor final", author: "Bertolt Brecht" },
            { text: "El arte no es un espejo para reflejar la realidad, sino un martillo para darle forma", author: "Bertolt Brecht" },
            { text: "Hay que tener caos dentro de uno para dar a luz una estrella danzante", author: "Nietzsche" },
            { text: "Un actor debe vivir para poder interpretar", author: "Konstantin Stanislavski" },
            { text: "El teatro es la pasi√≥n de contar historias", author: "Peter Brook" },
            { text: "La actuaci√≥n es la capacidad de comportarse de forma natural en circunstancias no naturales", author: "David Mamet" },
            { text: "El talento es entrega", author: "Uta Hagen" },
            { text: "El teatro es el arte del presente", author: "Jerzy Grotowski" },
            { text: "La imaginaci√≥n es m√°s importante que el conocimiento", author: "Albert Einstein" },
            { text: "El actor crea la vida; el director la hace visible", author: "Elia Kazan" },
            { text: "El teatro es el arte de mirar y de ser mirado", author: "Jean Genet" },
            { text: "El personaje nace cuando el actor se olvida de s√≠ mismo", author: "Grotowski" },
            { text: "El teatro es el espacio donde lo imposible sucede", author: "Peter Brook" },
            { text: "Una obra es un misterio revelado", author: "Yasmina Reza" },
            { text: "El humor es la distancia m√°s corta entre dos personas", author: "Victor Borge" },
            { text: "El escenario es mi piel", author: "Sarah Bernhardt" },
            { text: "La tragedia es imitaci√≥n de una acci√≥n elevada", author: "Arist√≥teles, Po√©tica" },
            { text: "La comedia es simplemente una tragedia que se niega a llorar", author: "Roberto Benigni" },
            { text: "Actuar es escuchar", author: "Alan Rickman" },
            { text: "No existe teatro sin conflicto", author: "George Bernard Shaw" },
            { text: "El actor debe ser un poeta del comportamiento", author: "Michael Chekhov" },
            { text: "La vida es teatro y el teatro es vida", author: "Jean-Louis Barrault" },
            { text: "Si no hay emoci√≥n, no hay arte", author: "Stanislavski" },
            { text: "Un personaje es un problema con piernas", author: "Tennessee Williams" },
            { text: "El p√∫blico siempre tiene raz√≥n", author: "Charles Chaplin" },
            { text: "La comedia es tragedia m√°s tiempo", author: "Mark Twain" },
            { text: "El teatro es el arte de convertir lo cotidiano en extraordinario", author: "Lee Strasberg" },
            { text: "Un actor se mide por sus silencios", author: "Robert De Niro" },
            { text: "El teatro vuelve visible lo invisible", author: "Peter Shaffer" },
            { text: "El teatro deber√≠a incomodar", author: "Bertolt Brecht" },
            { text: "El teatro no es literatura: es carne", author: "Heiner M√ºller" },
            { text: "El cuerpo del actor es su primer instrumento", author: "Grotowski" },
            { text: "Las palabras son buenas, pero el movimiento es mejor", author: "Pina Bausch" },
            { text: "Todo arte es una confesi√≥n", author: "Albert Camus" },
            { text: "El teatro es el arte de compartir el alma", author: "Laurence Olivier" },
            { text: "Si uno puede re√≠rse de s√≠ mismo, est√° a salvo", author: "Oscar Wilde" },
            { text: "La risa es un acto de resistencia", author: "Dario Fo" },
            { text: "La obra vive solo en el instante", author: "Peter Brook" },
            { text: "Un actor debe amar la duda", author: "Yoshi Oida" },
            { text: "La autenticidad es m√°s valiosa que la t√©cnica", author: "Uta Hagen" },
            { text: "El escenario es el lugar donde todo puede suceder", author: "Peter Brook" },
            { text: "Un buen actor no imita: revela", author: "Michael Chekhov" },
            { text: "El drama es conflicto", author: "Arist√≥teles" },
            { text: "La pasi√≥n hace al actor", author: "Sarah Bernhardt" },
            { text: "No hay papeles peque√±os, solo actores peque√±os", author: "Stanislavski" },
            { text: "Un personaje es una puerta hacia un mundo", author: "Caryl Churchill" },
            { text: "La obra termina cuando el espectador quiere", author: "Jean-Luc Godard" },
            { text: "El teatro es el reino de la contradicci√≥n", author: "Antonin Artaud" },
            { text: "La verdad es el mejor espect√°culo", author: "William Shakespeare" },
            { text: "El actor debe ser valiente", author: "Tennessee Williams" },
            { text: "Actuar es exponerse sin protecci√≥n", author: "Al Pacino" },
            { text: "La escena es el laboratorio de la humanidad", author: "Peter Brook" },
            { text: "La tragedia limpia el alma", author: "Arist√≥teles" },
            { text: "La risa es una confesi√≥n involuntaria", author: "Mark Twain" },
            { text: "El teatro nace del ritual", author: "Victor Turner" },
            { text: "La m√°scara revela lo que la cara oculta", author: "Jacques Lecoq" },
            { text: "Improvisar es confiar", author: "Keith Johnstone" },
            { text: "La ficci√≥n es la hermana mayor de la verdad", author: "George Steiner" },
            { text: "El teatro es un acto de fe", author: "Peter Brook" },
            { text: "Actuar es recordar lo olvidado", author: "Miguel √Ångel Sol√°" },
            { text: "La emoci√≥n es el puente entre actor y p√∫blico", author: "Lee Strasberg" },
            { text: "Mate al personaje, viva el actor", author: "Heiner M√ºller" },
            { text: "El teatro es pol√≠tica sin discurso", author: "Bertolt Brecht" },
            { text: "No actuamos para ser vistos, sino para ser entendidos", author: "Viola Spolin" },
            { text: "Cada funci√≥n es una vida nueva", author: "Laurence Olivier" },
            { text: "El drama empieza donde terminan las palabras", author: "Harold Pinter" },
            { text: "El actor trabaja con memoria y deseo", author: "Pina Bausch" },
            { text: "Una obra es un viaje emocional", author: "Arthur Miller" },
            { text: "Todo personaje tiene un secreto", author: "Tennessee Williams" },
            { text: "La escena es un ritual compartido", author: "Jerzy Grotowski" },
            { text: "El teatro es un acto de amor", author: "Peter Brook" },
            { text: "El cuerpo nunca miente", author: "Martha Graham" },
            { text: "La imaginaci√≥n lo es todo", author: "Einstein" },
            { text: "La tragedia necesita belleza", author: "Eur√≠pides" },
            { text: "La comedia necesita precisi√≥n", author: "Charlie Chaplin" },
            { text: "Actuar es un acto de vulnerabilidad extrema", author: "Kate Winslet" },
            { text: "La verdad del personaje nace de la escucha", author: "Meisner" },
            { text: "El teatro es memoria viva", author: "Arias Patricia" },
            { text: "Las emociones son el verdadero texto", author: "Uta Hagen" },
            { text: "La obra pertenece al p√∫blico", author: "Peter Brook" },
            { text: "El actor es el puente entre la ficci√≥n y la vida", author: "Michael Chekhov" },
            { text: "El teatro es una celebraci√≥n de lo humano", author: "Ariane Mnouchkine" },
            { text: "No hay nada m√°s serio que la comedia", author: "Roberto Benigni" },
            { text: "Actuar es jugar", author: "Viola Spolin" },
            { text: "El miedo es combustible", author: "Grotowski" },
            { text: "Un actor debe amar lo desconocido", author: "Peter Brook" },
            { text: "Todo gran teatro surge del riesgo", author: "Antonin Artaud" },
            { text: "La obra respira si vos respir√°s", author: "Lee Strasberg" },
            { text: "La escena es un mapa emocional", author: "Julian Beck" },
            { text: "El teatro es el arte m√°s vivo de todos", author: "Laurence Olivier" }
        ];

        function getFraseAleatoria() {
            const randomIndex = Math.floor(Math.random() * quotes.length);
            const quote = quotes[randomIndex];
            return `${quote.text} ‚Äî ${quote.author}`;
        }

        // Verificar autenticaci√≥n primero
        if (!Baco.Auth.requireAuth()) return;
        
        // Mostrar frase aleatoria (despu√©s de verificar auth)
        document.getElementById('fraseTexto').textContent = getFraseAleatoria();
        
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        if (user.role !== 'SUPER') {
            Baco.UI.showError('Acceso denegado. Solo Super Usuarios.');
            setTimeout(() => Baco.Auth.logout(), 2000);
            return;
        }

        // Cargar datos del perfil (si hay endpoint, refrescar desde backend)
        loadUserProfile();
        refreshFromServer();

        async function refreshFromServer() {
            try {
                const me = await Baco.API.get('/users/me');
                if (me) {
                    // Normalizar campos esperados por el frontend
                    user.cedula = me.cedula;
                    user.nombre = me.nombre || me.name || user.nombre;
                    user.name = me.nombre || me.name || user.name;
                    user.role = me.role || user.role;
                    user.email = me.email || null;
                    user.telefono = me.telefono || me.phone || null;
                    user.fecha_nacimiento = me.fecha_nacimiento || null;
                    user.foto_url = me.foto_url || null;
                    localStorage.setItem('user', JSON.stringify(user));
                    loadUserProfile();
                }
            } catch (e) {
                // Si falla, seguir con lo que hay en localStorage
                console.warn('No se pudo refrescar perfil desde servidor');
            }
        }

        function loadUserProfile() {
            const displayName = user.nombre || user.name || 'Super Usuario';
            document.getElementById('profileNameLarge').textContent = displayName;
            document.getElementById('profileCedula').textContent = Baco.Format.cedula(user.cedula) || '-';
            
            // Llenar formulario de datos personales
            document.getElementById('nombre').value = user.nombre || user.name || '';
            document.getElementById('cedula').value = Baco.Format.cedula(user.cedula) || '';
            document.getElementById('email').value = user.email || '';
            document.getElementById('fecha_nacimiento').value = user.fecha_nacimiento ? user.fecha_nacimiento.split('T')[0] : '';
            document.getElementById('telefono').value = user.telefono || user.phone || '';
            
            // Cargar foto
            const profilePhoto = document.getElementById('profilePhotoLarge');
            if (user.foto_url) {
                profilePhoto.src = user.foto_url;
            } else {
                profilePhoto.src = Baco.Image.getPlaceholder(displayName, 180);
            }
        }

        // Actualizar datos personales
        async function updatePersonalInfo(event) {
            event.preventDefault();

            const nombreValue = document.getElementById('nombre').value;
            const formData = {
                name: nombreValue,
                nombre: nombreValue,
                email: document.getElementById('email').value || null,
                fecha_nacimiento: document.getElementById('fecha_nacimiento').value || null,
                telefono: document.getElementById('telefono').value || null
            };

            // Validaciones
            if (!Baco.Validate.required(nombreValue)) {
                Baco.UI.showError('El nombre es obligatorio');
                return;
            }

            if (formData.email && !Baco.Validate.email(formData.email)) {
                Baco.UI.showError('Email inv√°lido');
                return;
            }

            if (formData.telefono && !Baco.Validate.phone(formData.telefono)) {
                Baco.UI.showError('Tel√©fono inv√°lido');
                return;
            }

            try {
                Baco.UI.showLoading('Actualizando datos...');

                const response = await Baco.API.put('/users/me', formData);
                
                Baco.UI.hideLoading();
                Baco.UI.showSuccess('Datos actualizados correctamente');
                
                // Actualizar localStorage con los datos del servidor
                if (response) {
                    user.name = response.name || user.name;
                    user.nombre = response.name || user.nombre;
                    user.email = response.email || user.email;
                    user.telefono = response.telefono || user.telefono;
                    user.fecha_nacimiento = response.fecha_nacimiento || user.fecha_nacimiento;
                    localStorage.setItem('user', JSON.stringify(user));
                }
                
                // Actualizar UI
                loadUserProfile();
            } catch (error) {
                console.error('Error:', error);
                Baco.UI.hideLoading();
                Baco.UI.showError(error.message || 'Error al actualizar los datos');
            }
        }

        // Manejar cambio de foto
        function handlePhotoChange(event) {
            const file = event.target.files[0];
            if (!file) return;

            Baco.Image.previewImage(file, (dataUrl) => {
                document.getElementById('profilePhotoLarge').src = dataUrl;
                uploadPhoto(file);
            });
        }

        async function uploadPhoto(file) {
            console.log('üì∏ Iniciando upload de foto:', file.name, file.type, file.size);
            Baco.UI.showLoading('Subiendo foto...');

            try {
                // Validar tipo de archivo
                if (!file.type.startsWith('image/')) {
                    throw new Error('El archivo debe ser una imagen');
                }

                // Validar tama√±o (m√°ximo 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    throw new Error('La imagen no debe superar 5MB');
                }

                const base64 = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        console.log('‚úÖ Archivo le√≠do, tama√±o base64:', reader.result.length);
                        resolve(reader.result);
                    };
                    reader.onerror = () => reject(new Error('No se pudo leer la imagen'));
                    reader.readAsDataURL(file);
                });

                console.log('üöÄ Enviando imagen al servidor...');
                const uploaded = await Baco.API.post('/upload/image', {
                    image: base64,
                    filename: file.name
                });

                console.log('üì¶ Respuesta del servidor:', uploaded);

                if (!uploaded?.url) {
                    throw new Error('El servidor no devolvi√≥ una URL v√°lida');
                }

                console.log('üíæ Actualizando perfil con foto:', uploaded.url);
                await Baco.API.put('/users/me', { foto_url: uploaded.url });

                Baco.UI.hideLoading();
                Baco.UI.showSuccess('Foto actualizada correctamente');

                // Actualizar UI
                user.foto_url = uploaded.url;
                localStorage.setItem('user', JSON.stringify(user));
                
                // Actualizar preview
                document.getElementById('profilePhotoLarge').src = uploaded.url;
                
                console.log('‚úÖ Foto actualizada exitosamente');
            } catch (error) {
                console.error('‚ùå Error completo:', error);
                Baco.UI.hideLoading();
                Baco.UI.showError(error.message || 'Error al actualizar la foto');
            }
        }

        // Cambiar contrase√±a
        async function changePassword(event) {
            event.preventDefault();

            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // Validaciones
            if (!Baco.Validate.required(currentPassword)) {
                Baco.UI.showError('Ingresa tu contrase√±a actual');
                return;
            }

            if (!Baco.Validate.password(newPassword)) {
                Baco.UI.showError('La nueva contrase√±a debe tener al menos 6 caracteres');
                return;
            }

            if (newPassword !== confirmPassword) {
                Baco.UI.showError('Las contrase√±as no coinciden');
                return;
            }

            try {
                Baco.UI.showLoading('Cambiando contrase√±a...');
                
                await Baco.API.post('/users/change-password', {
                    currentPassword,
                    newPassword
                });
                
                Baco.UI.hideLoading();
                Baco.UI.showSuccess('Contrase√±a actualizada correctamente');
                
                // Limpiar formulario
                document.getElementById('formPassword').reset();
            } catch (error) {
                console.error('Error:', error);
                Baco.UI.hideLoading();
                Baco.UI.showError(error.message || 'Error al cambiar la contrase√±a');
            }
        }

        // Cerrar sesi√≥n con confirmaci√≥n elegante
        async function handleLogout() {
            const confirmed = await Baco.UI.confirm(
                '¬øEst√°s seguro que quer√©s cerrar sesi√≥n?',
                'üé≠ Hasta pronto',
                'S√≠, cerrar sesi√≥n'
            );

            if (confirmed) {
                Baco.UI.showSuccess('Cerrando sesi√≥n...');
                setTimeout(() => {
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    window.location.href = '/index.html';
                }, 1000);
            }
        }
        })();
    </script>
</body>
</html>
